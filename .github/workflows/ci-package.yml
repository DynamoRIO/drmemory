# **********************************************************
# Copyright (c) 2020 Google, Inc.  All rights reserved.
# **********************************************************

# Dr. Memory: the memory debugger
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation;
# version 2.1 of the License, and no later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

# Github Actions workflow for release packages.

name: ci-package
on:
  # Our weekly cronbuild: 9pm on Fridays.
  schedule:
    - cron: '0 21 * * FRI'
  # Manual trigger using the Actions page.
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version number'
        required: true
        default: '0.0.0'
      build:
        description: 'Package build number'
        required: true
        default: '0'

defaults:
  run:
    shell: bash

jobs:
  # Linux tarball with 64-bit and 32-bit builds:
  x86:
    runs-on: ubuntu-16.04

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Fetch Sources
      run: git fetch --no-tags --depth=1 origin master

    # Install multilib for non-cross-compiling Linux build:
    - name: Create Build Environment
      run: sudo apt-get -y install doxygen jsonlint g++-multilib

    - name: Get Version
      id: version
      # XXX: for now we duplicate this version number here with CMakeLists.txt.
      # We should find a way to share (xref DRi#1565).
      # We support setting the version for manual builds to override all
      # parts of the version.  If a build is included (leading dash and number
      # at the end), it will be parsed and passed to package.cmake.  We only
      # use a non-zero build number when making multiple manual builds in one day.
      run: |
        if test -z "${{ github.event.inputs.version }}"; then
          export VERSION_NUMBER=$((`git log -n 1 --format=%ct` / (60*60*24)))
          export GIT_TAG="cronbuild-2.3.${VERSON_NUMBER}"
        else
          export VERSION_NUMBER=${{ github.event.inputs.version }}
          if [ "${{ github.event.inputs.build }}" -eq 0 ]; then
            export GIT_TAG="release_${VERSON_NUMBER}"
          else
            export GIT_TAG="release_${VERSON_NUMBER}-${{ github.event.inputs.build }}"
          fi
        fi
        echo "::set-output name=version_number::${VERSION_NUMBER}"
        echo "::set-output name=version_string::${GIT_TAG}"

    - name: Build Package
      working-directory: ${{ github.workspace }}
      run: ./tests/runsuite_wrapper.pl travis
      env:
        CI_TARGET: package
        VERSION_NUMBER: ${{ steps.version.outputs.version_number }}

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version_string }}
        release_name: ${{ steps.version.outputs.version_string }}
        body: |
          Auto-generated periodic build.
        draft: false
        prerelease: false

    - name: Upload Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        # This action doesn't seem to support a glob so we need the exact name.
        asset_path: DrMemory-Linux-${{ steps.version.outputs.version_number }}.tar.gz
        asset_name: drmemory.tar.gz
        asset_content_type: application/x-gzip
